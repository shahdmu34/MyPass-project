<!DOCTYPE html>
<head>

    <meta charset="UTF-8">
    <title>MyPass</title>
    <link rel="stylesheet" type="text/css" href="css/home_style.css" />
</head>
<body>
    <div class="container-app">
        <aside class="sideNav">
            <h3>MyPass</h3>

            <nav class="menuBar">

                <a href="home.html" class="menu  ">Edit Profile</a>
                <a href="payment.html" class="menu is-active">Payment Information</a>
                <a href="identity.html" class="menu">Identity</a>
                <a href="secure.html" class="menu">Secure Notes</a>
                <a href="login.html" class="menu">Sign Out</a>

            </nav>
        </aside>

        <main class="content">
            <h1>Payment information</h1>
            <!--credit card information-->
            <form class="edit-profile-form">
                <div class="form-group">
                    <label for="creditCard">Credit Card Number</label>
                    <input type="password" id="creditCard" name="creditCard" required>
                </div>

                <div class="form-group">
                    <label for="CVV">CVV</label>
                    <input type="password" id="CVV" name="CVV" required>
                </div>

                <div class="form-group">
                    <label for="Expiration">Expiration Date</label>
                    <input type="password" id="Expiration" name="Expiration" required>
                </div>

                <div>
                    <button id="toggleSensitiveInfo" type="button">Unmask Sensitive Information</button>
                </div>
                <br>


                <div>
                    <button type="submit">Save Information</button>
                </div>
            </form>
        </main>

        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
            import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
            import { getDatabase, set, ref, update, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyAaJ0fhXXd_WEuTwUTQJpa211weqA7ZQ6w",
                authDomain: "term-project-476.firebaseapp.com",
                projectId: "term-project-476",
                storageBucket: "term-project-476.appspot.com",
                messagingSenderId: "276408407460",
                appId: "1:276408407460:web:b05ec30e174fb0c3441d31"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            // Initialize user authentication
            const auth = getAuth(app);
            // Initialize database
            const database = getDatabase(app);


                    //code author: Zeinab Alrubaiee


            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    const user = auth.currentUser;

                    if (user) {
                        // The user object has basic properties such as display name, email, etc.

                        // Inside onAuthStateChanged function
                        const userRef = ref(database, 'Users/' + user.uid);

                        onValue(userRef, (snapshot) => {
                            const userData = snapshot.val();
                            if (userData) {
                                document.getElementById('creditCard').value = userData.creditCard || ''; // Set credit card
                                document.getElementById('CVV').value = userData.cvv || ''; // Set CVV
                                document.getElementById('Expiration').value = userData.expiration || ''; // Set Expiration
                            }
                        });

                        // Select the form element
                        const editProfileForm = document.querySelector('.edit-profile-form');

                        // Add event listener for form submission
                        editProfileForm.addEventListener('submit', (e) => {
                            e.preventDefault(); // Prevent the default form submission behavior

                            const credit = document.getElementById('creditCard').value;
                            const cvvCode = document.getElementById('CVV').value;
                            const expiration = document.getElementById('Expiration').value;

                            // Update user data in the database
                            update(userRef, {
                                creditCard: credit,
                                cvv: cvvCode,
                                expiration: expiration
                            }).then(() => {
                                alert('User information updated successfully.');
                            }).catch((error) => {
                                console.error('Error updating user information:', error);
                                // Handle errors or display an error message to the user
                            });
                        });
                    }
                } else {
                    // No user is signed in.
                    console.error("User log in error.")
                }
            });

            ////-------------Data Mask and Unmask Segment-------------

            //Subject
            class Mask {
                constructor() {

                }

                revealInformation() {

                }
            }

            //Real Subject
            class RealMask extends Mask {

                constructor () {
                    super(); // Invoke the superclass constructor
                    console.log("RealMask Initialized")
                }
                revealInformation () {
                    const creditCardField = document.getElementById('creditCard');
                    const cvvField = document.getElementById('CVV');
                    const expirationField = document.getElementById('Expiration');
                    const toggleSensitiveInfoButton = document.getElementById('toggleSensitiveInfo');

                    creditCardField.setAttribute('type', 'text');
                    cvvField.setAttribute('type', 'text');
                    expirationField.setAttribute('type', 'text');
                    toggleSensitiveInfoButton.textContent = 'Mask Sensitive Information';
                }
            }

            //Proxy
            class ProtectionProxy extends Mask {
                static sensitiveInfo;
                static realMask;

                constructor (isSensitiveInfoVisible) {
                    super(); // Invoke the superclass constructor
                    console.log("ProtectionProxy Initialized")
                    this.sensitiveInfo = isSensitiveInfoVisible;
                    this.realMask = new RealMask();
                }

                revealInformation () {
                    const creditCardField = document.getElementById('creditCard');
                    const cvvField = document.getElementById('CVV');
                    const expirationField = document.getElementById('Expiration');
                    const toggleSensitiveInfoButton = document.getElementById('toggleSensitiveInfo');

                    if (this.sensitiveInfo) {
                        this.realMask.revealInformation();
                    }
                    else {
                        creditCardField.setAttribute('type', 'password');
                        cvvField.setAttribute('type', 'password');
                        expirationField.setAttribute('type', 'password');
                        toggleSensitiveInfoButton.textContent = 'Unmask Sensitive Information';
                    }
                }
            }

            const toggleButton = document.getElementById('toggleSensitiveInfo');
            let isSensitiveInfoVisible = false;

            toggleButton.addEventListener('click', function() {
                isSensitiveInfoVisible = !isSensitiveInfoVisible;
                console.log(isSensitiveInfoVisible.toString());
                let informationProtector = new ProtectionProxy(isSensitiveInfoVisible);
                informationProtector.revealInformation();
            });
        </script>


    </div>




</body>

</html>
